<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco FoodCalc - Diet Optimizer</title>
    <style>
        /* Basic Styles */
        body { font-family: sans-serif; margin: 20px; }
        h1 { color: #333; display: inline-block; margin: 0; }
        
        /* Version Top Right */
        #version-display { float: right; font-size: 0.9em; color: #555; }
        
        .food-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .food-list th, .food-list td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .food-list th { background-color: #f2f2f2; }
        
        /* Highlighting Rows */
        .row-favorite { background-color: #fffacd; /* Light Yellow */ }
        .row-worst { background-color: #ffcccc; /* Light Red */ }
        
        /* Status and Tag Styles */
        .status-select { padding: 5px; border-radius: 4px; }

        /* Footer Style */
        footer { margin-top: 50px; font-size: 0.8em; color: #666; }
        
        #food-search-input {
            padding: 10px;
            font-size: 16px;
            width: 50%;
            margin-top: 10px;
        }
        #stomach-size-input {
            padding: 5px;
            width: 80px;
            text-align: right;
        }
        
        /* Ajuste 1: Centralização dos Selects de Tags */
        #global-tags-section {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centraliza o conteúdo (h3 e div) */
            margin-bottom: 20px;
        }
        #fav-worst-selects {
            display: flex;
            justify-content: space-between;
            width: 600px; /* Largura fixa para manter o alinhamento */
            max-width: 100%;
        }
        #fav-worst-selects select {
            padding: 8px;
            font-size: 14px;
            width: 280px;
        }
    </style>
</head>
<body>

    <div id="version-display">
        Version 0.1<br>
        Last update: <span id="last-update-date"></span>
    </div>
    
    <h1>Eco FoodCalc - Diet Optimizer</h1>
    
    <p>Current Session Status: <span id="user-session"></span></p> 
    <button onclick="resetPreferences()" style="padding: 5px 10px; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px;">Reset All Preferences</button>
    
    <p>This tool helps maximize your **Nutrition Bonus** for faster skill point gain in Eco.</p>
    
    <div style="margin-bottom: 20px;">
        <label for="stomach-size-input">Stomach Size (Calories): </label>
        <input type="number" id="stomach-size-input" value="3000" min="100" onchange="updateStomachSize(this.value)">
    </div>
    
    <div id="food-container"></div> 

    <footer>
        <hr>
        <p>Created by CrazySpy.</p>
    </footer>

    <script>
        const FOOD_SOURCE_URL = 'foodsource.json';
        
        // Define ALL possible status states.
        const FOOD_STATUS_KEYS = {
            'REMOVE_FROM_LIST': 'Remove from list', 
            'DELICIOUS': 'Delicious', 
            'GOOD': 'Good', 
            'OK': 'Ok', 
            'BAD': 'Bad', 
            'HORRIBLE': 'Horrible'
        };

        const STATUS_OPTIONS = Object.values(FOOD_STATUS_KEYS);
        const DATA_STORAGE_KEY = 'eco_food_preferences';
        const STOMACH_SIZE_KEY = 'eco_stomach_size';
        const FAVORITE_KEY = 'eco_favorite_food'; // Novo para controle global
        const WORST_KEY = 'eco_worst_food'; // Novo para controle global
        
        // Global variables
        let foodData = [];
        let userPreferences = {};
        let stomachSize = 3000;
        let favoriteFood = ''; // Nome da comida favorita
        let worstFood = '';    // Nome da comida pior

        // --- Core Functions ---

        /**
         * Initializes the application: loads JSON data and user preferences.
         */
        async function initApp() {
            const container = document.getElementById('food-container');
            const sessionElement = document.getElementById('user-session');
            
            sessionElement.textContent = 'Checking preferences...';
            container.innerHTML = 'Loading food data...'; // Dynamic loading message

            try {
                // 1. Load the JSON file
                const response = await fetch(FOOD_SOURCE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                foodData = await response.json();

                // 2. Load user preferences, stomach size, and global tags
                loadUserPreferences();
                loadStomachSize();
                loadGlobalTags();

                // 3. Render the two main components (Evaluated List + Search)
                renderFoodLists(); 
                
            } catch (error) {
                console.error("Error loading or processing JSON:", error);
                container.innerHTML = `<p style="color: red;">Error loading ${FOOD_SOURCE_URL}. Please check the file name and format.</p>`;
                sessionElement.textContent = 'Failed to start session.';
            }

            // 4. Fetch the last commit date (footer/header)
            fetchLastCommitDate();
        }

        /**
         * Loads preferences from localStorage or sets initial 'Remove from list' status.
         */
        function loadUserPreferences() {
            const storedData = localStorage.getItem(DATA_STORAGE_KEY);
            const sessionElement = document.getElementById('user-session');

            if (storedData) {
                userPreferences = JSON.parse(storedData);
                sessionElement.textContent = 'Preferences loaded.';
            } else {
                // Initialize preferences: every item starts as 'Remove from list'
                foodData.forEach(item => {
                    const name = item.Food_Name;
                    userPreferences[name] = {
                        status: FOOD_STATUS_KEYS.REMOVE_FROM_LIST, 
                    };
                });
                saveUserPreferences();
                sessionElement.textContent = 'New session initialized (All set to Remove from list).';
            }
        }

        /**
         * Saves current user preferences to localStorage.
         */
        function saveUserPreferences() {
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(userPreferences));
        }

        /**
         * Clears all saved data (preferences and stomach size) and reloads the app.
         */
        function resetPreferences() {
            if (confirm('Are you sure you want to delete ALL saved preferences (food status, tags, and stomach size)? This action cannot be undone.')) {
                localStorage.removeItem(DATA_STORAGE_KEY);
                localStorage.removeItem(STOMACH_SIZE_KEY);
                localStorage.removeItem(FAVORITE_KEY); // Remove tags globais
                localStorage.removeItem(WORST_KEY);     // Remove tags globais
                localStorage.removeItem('last-commit-date'); 
                localStorage.removeItem('last-commit-etag');
                
                // Recarrega o app para iniciar do zero
                window.location.reload();
            }
        }

        /**
         * Loads global tags (Favorite/Worst) from localStorage.
         */
        function loadGlobalTags() {
            favoriteFood = localStorage.getItem(FAVORITE_KEY) || '';
            worstFood = localStorage.getItem(WORST_KEY) || '';
        }

        /**
         * Loads the Stomach Size from localStorage or defaults to 3000.
         */
        function loadStomachSize() {
            const storedSize = localStorage.getItem(STOMACH_SIZE_KEY);
            if (storedSize) {
                stomachSize = parseInt(storedSize);
            }
            // Update the input field with the loaded/default value
            const inputElement = document.getElementById('stomach-size-input');
            if(inputElement) inputElement.value = stomachSize;
        }

        /**
         * Saves the Stomach Size to localStorage.
         */
        function saveStomachSize() {
            localStorage.setItem(STOMACH_SIZE_KEY, stomach
