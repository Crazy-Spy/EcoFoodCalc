<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco FoodCalc - Diet Optimizer</title>
    <style>
        /* Basic Styles */
        body { font-family: sans-serif; margin: 20px; }
        h1 { color: #333; }
        .food-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .food-list th, .food-list td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .food-list th { background-color: #f2f2f2; }
        /* Status and Tag Styles */
        .status-select { padding: 5px; border-radius: 4px; }
        .tag-button { 
            margin: 2px; 
            padding: 5px 10px; 
            cursor: pointer; 
            border: 1px solid #aaa; 
            border-radius: 4px;
            background-color: #e9e9e9;
        }
        .tag-favorite { background-color: #ffd700; border-color: gold; font-weight: bold; }
        .tag-worst { background-color: #ffb6c1; border-color: #f08080; }
    </style>
</head>
<body>

    <h1>Eco FoodCalc - Diet Optimizer</h1>
    <p>Current Session Status: <span id="user-session">Loading...</span></p>
    <p>This tool helps maximize your **Nutrition Bonus** for faster skill point gain in Eco.</p>
    
    <div id="food-container">
        Loading data...
    </div>

    <script>
        const FOOD_SOURCE_URL = 'foodsource.json';
        
        // Define ALL possible status states and map them to localization keys for future-proofing
        const FOOD_STATUS_KEYS = {
            'NEVER_TRIED': 'Never Tried', 
            'DELICIOUS': 'Delicious', 
            'GOOD': 'Good', 
            'OK': 'Ok', 
            'BAD': 'Bad', 
            'HORRIBLE': 'Horrible'
        };

        const STATUS_OPTIONS = Object.values(FOOD_STATUS_KEYS);
        const DATA_STORAGE_KEY = 'eco_food_preferences';
        
        // Global variables
        let foodData = [];
        let userPreferences = {};

        // --- Core Functions ---

        /**
         * Initializes the application: loads JSON data and user preferences.
         */
        async function initApp() {
            try {
                // 1. Load the JSON file
                const response = await fetch(FOOD_SOURCE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                foodData = await response.json();

                // 2. Load user preferences or initialize them
                loadUserPreferences();

                // 3. Render the list
                renderFoodList();
                
            } catch (error) {
                console.error("Error loading or processing JSON:", error);
                document.getElementById('food-container').innerHTML = `<p style="color: red;">Error loading ${FOOD_SOURCE_URL}. Please check the file name and format.</p>`;
            }
        }

        /**
         * Loads preferences from localStorage or sets initial 'Never Tried' status.
         */
        function loadUserPreferences() {
            const storedData = localStorage.getItem(DATA_STORAGE_KEY);
            if (storedData) {
                userPreferences = JSON.parse(storedData);
                document.getElementById('user-session').textContent = 'Preferences loaded from local storage.';
            } else {
                // Initialize preferences: every item starts as 'Never Tried'
                foodData.forEach(item => {
                    const name = item.Food_Name;
                    userPreferences[name] = {
                        status: FOOD_STATUS_KEYS.NEVER_TRIED, 
                        isFavorite: false,
                        isWorst: false
                    };
                });
                saveUserPreferences();
                document.getElementById('user-session').textContent = 'New session initialized (All set to Never Tried).';
            }
        }

        /**
         * Saves current user preferences to localStorage.
         */
        function saveUserPreferences() {
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(userPreferences));
        }

        /**
         * Renders the main food list table.
         */
        function renderFoodList() {
            const container = document.getElementById('food-container');
            let html = '<table class="food-list">';
            
            // Table Header
            html += '<thead><tr><th>Food Name</th><th>Carbs</th><th>Fat</th><th>Protein</th><th>Vitamins</th><th>Calories (Game)</th><th>Status</th><th>Tags</th></tr></thead>';
            html += '<tbody>';

            // Table Body
            foodData.forEach(item => {
                const name = item.Food_Name;
                // Ensure item has a preference entry (for robustness), defaulting to 'Never Tried'
                const prefs = userPreferences[name] || { status: FOOD_STATUS_KEYS.NEVER_TRIED, isFavorite: false, isWorst: false };
                
                // Define classes and symbols for tags
                const favClass = prefs.isFavorite ? ' tag-favorite' : '';
                const worstClass = prefs.isWorst ? ' tag-worst' : '';
                
                html += `<tr>
                    <td>${name}</td>
                    <td>${item.Carbs}</td>
                    <td>${item.Fat}</td>
                    <td>${item.Protein}</td>
                    <td>${item.Vitamins}</td>
                    <td>${item.Official_Calories_Game}</td>
                    <td>
                        <select class="status-select" onchange="updateFoodStatus('${name}', this.value)">
                            ${STATUS_OPTIONS.map(s => 
                                // Checks if the current status 's' is the user's saved preference
                                // If it's the first visit, prefs.status is 'Never Tried'
                                `<option value="${s}" ${s === prefs.status ? 'selected' : ''}>${s}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <button class="tag-button${favClass}" onclick="toggleTag('${name}', 'isFavorite')">${prefs.isFavorite ? '★' : '☆'} Favorite</button>
                        <button class="tag-button${worstClass}" onclick="toggleTag('${name}', 'isWorst')">${prefs.isWorst ? '☠' : '⛌'} Worst</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- User Interaction Functions ---

        /**
         * Updates the status (Delicious, Good, etc.) for a food item.
         */
        function updateFoodStatus(foodName, newStatus) {
            userPreferences[foodName].status = newStatus;
            saveUserPreferences();
            console.log(`Status of ${foodName} updated to ${newStatus}`);
        }

        /**
         * Toggles the Favorite or Worst tag for a food item.
         */
        function toggleTag(foodName, tag) {
            userPreferences[foodName][tag] = !userPreferences[foodName][tag];
            saveUserPreferences();
            renderFoodList(); // Re-render to update tag button appearance
            console.log(`${tag} status for ${foodName}
